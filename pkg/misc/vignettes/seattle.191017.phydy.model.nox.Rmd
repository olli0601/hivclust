---
title: "**Phylodynamic analysis: transmission dynamics between US born and foreign born individuals in King County Seattle**"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
```{r, include=TRUE, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, tidy=TRUE}
require(knitr)
require(kableExtra)
require(ggplot2)
```
```{r, include=FALSE, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, tidy=TRUE}
require(rmarkdown)
setwd('~/git/hivclust/pkg/misc/vignettes') 
rmarkdown::render('seattle.191017.phydy.model.nox.Rmd')
```
```{r, include=TRUE, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, tidy=TRUE}
read_chunk('~/git/hivclust/pkg/misc/hivclu.Seattle.R')		
```

## **Epidemiologic model, local population**
The overall aim is to specify an epidemic model that captures transmission
dynamics among heterosexuals by migrant-status. Consider the following states
$$
(S^j_{gi}, I^j_{gi}, T^j_{gi})
$$ 
where $S$, $I$, $T$ denote respectively groups of susceptible, infected and
treated individuals and 

* $j$ denotes location, respectively $l$ (local, King County) or $x$
(external, world) 
* $g$ denotes gender, respectively $m$ (male) and $j$
(female) 
* $i$ denotes migration status. This can be ethnicity, respectively
$0$ (white) and $1$ (non-white). Or alternatively location of birth,
respectively $0$ (US-born) and $1$ (foreign-born). 

Our basic ODE equations for the transmission dynamics involving the local
susceptible population are 
$$
\begin{align}
    \dot{S}^l_{f0} &= - (\beta_{00} I^l_{m0}+\beta_{10} I^l_{m1} ) S^l_{f0} /N^l + \mu (S^l_{f0}/S^l) - \mu S^l_{f0} \\
    \dot{S}^l_{f1} &= - (\beta_{01} I^l_{m0}+\beta_{11} I^l_{m1} ) S^l_{f1} /N^l + \mu (S^l_{f1}/S^l) - \mu S^l_{f1}\\
    \dot{S}^l_{m0} &= - (\beta_{00} I^l_{f0}+\beta_{10} I^l_{f1} ) S^l_{m0} /N^l + \mu (S^l_{m0}/S^l) - \mu S^l_{m0} \\
    \dot{S}^l_{m1} &= - (\beta_{01} I^l_{f0}+\beta_{11} I^l_{f1} ) S^l_{m1} /N^l + \mu (S^l_{m1}/S^l) - \mu S^l_{m1}\\ 
\end{align}
$$
where 

* $\mu$ is the birth/death rate
* $S^l = S^l_{f0} + S^l_{f1} + S^l_{m0} + S^l_{m1}$
* $N^l$ is the sum of all compartments involving the local population
* $\beta_{ij}$ is the transmission rate from individuals with migration status
  $i$ to migration status $j$.

The remaining model equations involving the local population are  
$$
\begin{align}
    \dot{I}^l_{f0} &= (\beta_{00} I^l_{m0}+\beta_{10} I^l_{m1} ) S^l_{f0} /N^l - \gamma I^l_{f0} - \mu I^l_{f0} \\
    \dot{I}^l_{f1} &= (\beta_{01} I^l_{m0}+\beta_{11} I^l_{m1} ) S^l_{f1} /N^l - \gamma I^l_{f1} - \mu I^l_{f1}\\
    \dot{I}^l_{m0} &= (\beta_{00} I^l_{f0}+\beta_{10} I^l_{f1} ) S^l_{m0} /N^l - \gamma I^l_{m0} - \mu I^l_{m0} \\
    \dot{I}^l_{m1} &= (\beta_{01} I^l_{f0}+\beta_{11} I^l_{f1} ) S^l_{m1} /N^l - \gamma I^l_{m1} - \mu I^l_{m1}\\
    \dot{T}^l_{f0} &= \gamma I^l_{f0} - \mu T^l_{f0} \\
    \dot{T}^l_{f1} &= \gamma I^l_{f1} - \mu T^l_{f1}\\
    \dot{T}^l_{m0} &= \gamma I^l_{m0} - \mu T^l_{m0} \\
    \dot{T}^l_{m1} &= \gamma I^l_{m1} - \mu T^l_{m1}\\ 
\end{align}
$$
where

* $\gamma$ is the rate at which infected individuals become virally suppressed due to
antiretrovirals. We assume that infected individuals that reached viral
suppression remain suppressed until death.

The above is a fairly standard two-group SIR model. Let us explore performance
of phylodynamic parameter estimates on this model before we move on to more
complicated things.


## **Phylodynamic implementation**
Using standard notation, we define the $m=4$ demes backwards in time by
$$
\boldsymbol{Y}(t)= \big(  I^l_{f0}(t), I^l_{f1}(t), I^l_{m0}(t), I^l_{m1}(t)\big).
$$
The population sizes in the demes are further influenced by the non-deme
variables
$$
\boldsymbol{Y}^\prime(t)= \big(  S^l_{f0}(t), S^l_{f1}(t), S^l_{m0}(t), S^l_{m1}(t), T^l_{f0}(t), T^l_{f1}(t), T^l_{m0}(t), T^l_{m1}(t)\big).
$$
The birth matrix corresponding to the ODE model above is
$$
\boldsymbol{F}(t,\boldsymbol{Y}, \boldsymbol{Y}^\prime)= 
\left[\begin{array}
{rrrrr}
0 & 0 & \beta_{00}I^l_{m0}S^l_{f0}/N^l & \beta_{10}I^l_{m1}S^l_{f0}/N^l \\
0 & 0 & \beta_{01}I^l_{m0}S^l_{f1}/N^l & \beta_{11}I^l_{m1}S^l_{f1}/N^l \\
\beta_{00}I^l_{f0}S^l_{m0}/N^l & \beta_{10}I^l_{f1}S^l_{m0}/N^l & 0 & 0 \\
\beta_{01}I^l_{f0}S^l_{m1}/N^l & \beta_{11}I^l_{f1}S^l_{m1}/N^l & 0 & 0 \\
\end{array}\right],
$$
where we ommitted dependencies on time on the right hand side.
The entry $F_{ij}(t)$ describes the rate at which individuals in deme $i$ are generated by individuals in deme $j$.
The migration matrix corresponding to the ODE model above is
$$
\boldsymbol{G}(t,\boldsymbol{Y}, \boldsymbol{Y}^\prime)= 
\left[\begin{array}
{rrrrr}
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
\end{array}\right].
$$
The entry $G_{ij}(t)$ describes the rate at which individuals in deme $i$ migrate from individuals in deme $j$.
The death vector corresponding to the ODE model above is
$$
\boldsymbol{\mu}(t,\boldsymbol{Y}, \boldsymbol{Y}^\prime)= 
\left[\begin{array}
{r}
(\gamma+\mu) I^l_{f0} \\
(\gamma+\mu) I^l_{f1} \\
(\gamma+\mu) I^l_{m0} \\
(\gamma+\mu) I^l_{m1} \\
\end{array}\right].
$$
The non-deme dynamics are given by
$$
\boldsymbol{N}(t,\boldsymbol{Y}, \boldsymbol{Y}^\prime)= 
\left[\begin{array}{r}
\mu*N^l*\frac{S_{f0}}{S^l_{f0}+S^l_{f1}+S^l_{m0}+S^l_{m1}} - \mu*S^l_{f0} - \beta*(\beta_{00}*I^l_{m0}+\beta_{10}*I^l_{m1})*S^l_{f0}/N^l \\
\mu*N^l*\frac{S_{f1}}{S^l_{f0}+S^l_{f1}+S^l_{m0}+S^l_{m1}} - \mu*S^l_{f1} - \beta*(\beta_{01}*I^l_{m0}+\beta_{11}*I^l_{m1})*S^l_{f1}/N^l \\
\mu*N^l*\frac{S_{m0}}{S^l_{f0}+S^l_{f1}+S^l_{m0}+S^l_{m1}} - \mu*S^l_{m0} - \beta*(\beta_{00}*I^l_{f0}+\beta_{10}*I^l_{f1})*S^l_{m0}/N^l \\
\mu*N^l*\frac{S_{m1}}{S^l_{f0}+S^l_{f1}+S^l_{m0}+S^l_{m1}} - \mu*S^l_{m1} - \beta*(\beta_{01}*I^l_{f0}+\beta_{11}*I^l_{f1})*S^l_{m1}/N^l \\
\gamma*I^l_{f0} - \mu*T^l_{f0}\\
\gamma*I^l_{f1} - \mu*T^l_{f1}\\
\gamma*I^l_{m0} - \mu*T^l_{m0}\\
\gamma*I^l_{m1} - \mu*T^l_{m1}\\
\end{array}\right].
$$


The phylodynamic model has 12 states for the local population with initial
values to be specified, and parameters 
$$
(\beta, \beta_{00}, \beta_{01}, \beta_{10}, \beta_{11}, \gamma, \mu),
$$
of which $1$ is over-specified. Our first goal is to explore inference of 
$$
(\beta, \beta_{00}, \beta_{01}, \beta_{10}),
$$
with all other parameters set to the true values in simulations. 

 
## **Simulations**
The following table describes the parameter values and initial values that we
use in simulations:
$$
\begin{align}
N^l(0)= & 10^6 & \text{population size Seattle}\\
p_F= & 0.5 & \text{proportion female}\\
p_0= & 0.3 & \text{proportion class 0}\\
S^l_{f0}(0)= & N^l(0)*0.99*p_F*p_0 & \text{female susceptibles class 0}\\
S^l_{f1}(0)= & N^l(0)*0.99*p_F*(1-p_0) & \text{female susceptibles class 1}\\
I^l_{f0}(0)= & N^l(0)*0.01*0.2*p_F*p_0 & \text{female infectious class 0}\\
I^l_{f1}(0)= & N^l(0)*0.01*0.2*p_F*(1-p_0) & \text{female infectious class 1}\\
T^l_{f0}(0)= & N^l(0)*0.01*0.8*p_F*p_0 & \text{female treated class 0}\\
T^l_{f1}(0)= & N^l(0)*0.01*0.8*p_F*(1-p_0) & \text{female treated class 1}\\
\mu= & 1/40 & \text{birth-death rate}  
\end{align} 
$$
I then used endemic equilibrium conditions to set:
$$
\begin{align}
\gamma= & \mu*\frac{T^l_{f0}(0)+T^l_{f1}(0)+T^l_{m0}(0)+T^l_{m1}(0)}{ I^l_{m0}(0)+I^l_{m1}(0) }\\
\beta= & (\gamma+\mu)*\frac{I^l_{m0}(0)+I^l_{m1}(0)}{I^l_{f0}(0)+I^l_{f1}(0)}*\frac{1}{(S^l_{m0}(0)+S^l_{m1}(0))/N^l}
\end{align} 
$$
The simulations varied in terms of the WAIFM matrix
$$
\boldsymbol{\omega}= 
\left[\begin{array}
{rrrrr}
\omega_{00} & \omega_{01} \\
\omega_{10} & \omega_{11}\\
\end{array}\right]
$$
in which rows sum to $1$. To calibrate the WAIFM matrix to the above initial
population sizes, I calculated the average transmission rate under
$\beta_{ij}=1$,
$$
\bar{\beta}= \beta*(\frac{S^l_{f0}*I^l_{m0}}{(N^l)^2} + \frac{S^l_{f1}*I^l_{m0}}{(N^l)^2} + \cdots + \frac{S^l_{m1}*I^l_{f1}}{(N^l)^2} ),
$$
and the average transmission rate under the WAIFM matrix,
$$
\tilde{\beta}= \beta*(\omega_{00}\frac{S^l_{f0}*I^l_{m0}}{(N^l)^2} + \omega_{01}\frac{S^l_{f1}*I^l_{m0}}{(N^l)^2} + \cdots + \omega_{11}\frac{S^l_{m1}*I^l_{f1}}{(N^l)^2} ),
$$
and then specified
$$
\left[\begin{array}
{rrrrr}
\beta_{00} & \beta_{01} \\
\beta_{10} & \beta_{11}\\
\end{array}\right]= 
\left[\begin{array}
{rrrrr}
\omega_{00} & \omega_{01} \\
\omega_{10} & \omega_{11}\\
\end{array}\right]*\frac{\bar{\beta}}{\tilde{\beta}}.
$$

## **Simulation scenarios 1 and 2**
I first wanted to see if no spread between class $0$ and $1$ can be
distinguished from homogeneous spread between classes $0$ and $1$, with 
$100$, $500$, $1000$ samples from the population obtained in the last $10$
years of an epidemic simulation.

No spread between class $0$ and $1$:
$$
\boldsymbol{\omega}= 
\left[\begin{array}
{rrrrr}
1 & 0 \\
0 & 1\\
\end{array}\right]
$$

```{r, out.width="100%", out.height="900", include=TRUE, fig.align="center", echo=FALSE}
knitr::include_graphics("/Users/Oliver/Box Sync/OR_Work/Seattle/analysis_191017/phydy/SubtypeALL_annotated_dated_collapsed_tree_KCHSX021.pdf")
```

As next step, I collected the phylogenetic input data for the phylodynamic
analysis on heterosexual individuals from King County. In this step, I extracted
from the dated phylogenies subgraphs of two or more heterosexual
individuals plus a few background sequences, and then concatenated them all
into a bifurcating dated tree.  

Here is the code:
```{r,include=TRUE, eval=FALSE, echo=TRUE, warning=FALSE,message=FALSE, tidy=FALSE} 
<<rmd.chunk.seattle.191017.phydy.select.taxa>>
```

Let us have a look at the phylogenetic input data:
```{r,include=TRUE, eval=TRUE, echo=TRUE, warning=FALSE,message=FALSE, tidy=FALSE} 
require(data.table)
require(ape)
home <- '~/Box Sync/OR_Work/Seattle/analysis_191017'
indir <- file.path(home,'phydy')	
outdir <- file.path(home,'phydy')
infiles <- data.table(F=list.files(indir, pattern='^SubtypeALL_.*newick', full.names=TRUE, recursive=TRUE))
infiles[, OPT:= gsub('^.*_([A-Za-z0-9]+).newick$','\\1',basename(F))]
localstate.regex <- '^KCHSX.*'
#	select KCHSX analysis and load
localstate <- gsub('[^A-Za-z]','',localstate.regex)
infile <- subset(infiles, grepl(localstate,OPT))[,F]
ph <- read.tree(infile)
ph
```

The number of "local" and "external" sequences is:
```{r,include=TRUE, eval=TRUE, echo=TRUE, warning=FALSE,message=FALSE, tidy=FALSE} 
df <- data.table(TAXA=ph$tip.label)
df[, LOCAL_TIP:= grepl(localstate.regex, TAXA)]
df[, table(LOCAL_TIP)]
```

The phylogeny is:
```{r, include=TRUE, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE, tidy=FALSE, fig.dim = c(6, 15), fig.align="center", dpi=300} 
tip.col <- rep('blue',Ntip(ph))	
tip.col[ grepl(localstate.regex, ph$tip.label) ] <- 'red'
pdf(file=outfile, w=6, h=12)
plot(ph, show.tip.label=TRUE, tip.col=tip.col, cex=0.25)
axisPhylo()
dev.off()	
```
 
 