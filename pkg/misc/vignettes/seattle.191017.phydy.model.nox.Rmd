---
title: "**Phylodynamic analysis: transmission dynamics between US born and foreign born individuals in King County Seattle**"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
```{r, include=TRUE, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, tidy=TRUE}
require(knitr)
require(kableExtra)
require(ggplot2)
```
```{r, include=FALSE, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, tidy=TRUE}
require(rmarkdown)
setwd('~/git/hivclust/pkg/misc/vignettes') 
rmarkdown::render('seattle.191017.phydy.model.nox.Rmd')
```
```{r, include=TRUE, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE, tidy=TRUE}
read_chunk('~/git/hivclust/pkg/misc/hivclu.Seattle.R')		
```

## **Epidemiologic model, local population**
The overall aim is to specify an epidemic model that captures transmission
dynamics among heterosexuals by migrant-status. Consider the following states
$$
(S^j_{gi}, I^j_{gi}, T^j_{gi})
$$ 
where $S$, $I$, $T$ denote respectively groups of susceptible, infected and
treated individuals and 

* $j$ denotes location, respectively $l$ (local, King County) or $x$
(external, world) 
* $g$ denotes gender, respectively $m$ (male) and $j$
(female) 
* $i$ denotes migration status. This can be ethnicity, respectively
$0$ (white) and $1$ (non-white). Or alternatively location of birth,
respectively $0$ (US-born) and $1$ (foreign-born). 

Our basic ODE equations for the transmission dynamics involving the local
susceptible population are 
$$
\begin{align}
    \dot{S}^l_{f0} &= - (\beta_{00} I^l_{m0}+\beta_{10} I^l_{m1} ) S^l_{f0} /N^l + \mu (S^l_{f0}/S^l) - \mu S^l_{f0} \\
    \dot{S}^l_{f1} &= - (\beta_{01} I^l_{m0}+\beta_{11} I^l_{m1} ) S^l_{f1} /N^l + \mu (S^l_{f1}/S^l) - \mu S^l_{f1}\\
    \dot{S}^l_{m0} &= - (\beta_{00} I^l_{f0}+\beta_{10} I^l_{f1} ) S^l_{m0} /N^l + \mu (S^l_{m0}/S^l) - \mu S^l_{m0} \\
    \dot{S}^l_{m1} &= - (\beta_{01} I^l_{f0}+\beta_{11} I^l_{f1} ) S^l_{m1} /N^l + \mu (S^l_{m1}/S^l) - \mu S^l_{m1}\\ 
\end{align}
$$
where 

* $\mu$ is the birth/death rate
* $S^l = S^l_{f0} + S^l_{f1} + S^l_{m0} + S^l_{m1}$
* $N^l$ is the sum of all compartments involving the local population
* $\beta_{ij}$ is the transmission rate from individuals with migration status
  $i$ to migration status $j$.

The remaining model equations involving the local population are  
$$
\begin{align}
    \dot{I}^l_{f0} &= (\beta_{00} I^l_{m0}+\beta_{10} I^l_{m1} ) S^l_{f0} /N^l - \gamma I^l_{f0} - \mu I^l_{f0} \\
    \dot{I}^l_{f1} &= (\beta_{01} I^l_{m0}+\beta_{11} I^l_{m1} ) S^l_{f1} /N^l - \gamma I^l_{f1} - \mu I^l_{f1}\\
    \dot{I}^l_{m0} &= (\beta_{00} I^l_{f0}+\beta_{10} I^l_{f1} ) S^l_{m0} /N^l - \gamma I^l_{m0} - \mu I^l_{m0} \\
    \dot{I}^l_{m1} &= (\beta_{01} I^l_{f0}+\beta_{11} I^l_{f1} ) S^l_{m1} /N^l - \gamma I^l_{m1} - \mu I^l_{m1}\\
    \dot{T}^l_{f0} &= \gamma I^l_{f0} - \mu T^l_{f0} \\
    \dot{T}^l_{f1} &= \gamma I^l_{f1} - \mu T^l_{f1}\\
    \dot{T}^l_{m0} &= \gamma I^l_{m0} - \mu T^l_{m0} \\
    \dot{T}^l_{m1} &= \gamma I^l_{m1} - \mu T^l_{m1}\\ 
\end{align}
$$
where

* $\gamma$ is the rate at which infected individuals become virally suppressed due to
antiretrovirals. We assume that infected individuals that reached viral
suppression remain suppressed until death.

The above is a fairly standard two-group SIR model. Let us explore performance
of phylodynamic parameter estimates on this model before we move on to more
complicated things.


## **Phylodynamic implementation**
Using standard notation, we define the $m=4$ demes backwards in time by
$$
\boldsymbol{Y}(t)= \big(  I^l_{f0}(t), I^l_{f1}(t), I^l_{m0}(t), I^l_{m1}(t)\big).
$$
The population sizes in the demes are further influenced by the non-deme
variables
$$
\boldsymbol{Y}^\prime(t)= \big(  S^l_{f0}(t), S^l_{f1}(t), S^l_{m0}(t), S^l_{m1}(t), T^l_{f0}(t), T^l_{f1}(t), T^l_{m0}(t), T^l_{m1}(t)\big).
$$
The birth matrix corresponding to the ODE model above is
$$
\boldsymbol{F}(t,\boldsymbol{Y}, \boldsymbol{Y}^\prime)= 
\left[\begin{array}
{rrrrr}
0 & 0 & \beta_{00}I^l_{m0}S^l_{f0}/N^l & \beta_{10}I^l_{m1}S^l_{f0}/N^l \\
0 & 0 & \beta_{01}I^l_{m0}S^l_{f1}/N^l & \beta_{11}I^l_{m1}S^l_{f1}/N^l \\
\beta_{00}I^l_{f0}S^l_{m0}/N^l & \beta_{10}I^l_{f1}S^l_{m0}/N^l & 0 & 0 \\
\beta_{01}I^l_{f0}S^l_{m1}/N^l & \beta_{11}I^l_{f1}S^l_{m1}/N^l & 0 & 0 \\
\end{array}\right],
$$
where we ommitted dependencies on time on the right hand side.
The entry $F_{ij}(t)$ describes the rate at which individuals in deme $i$ are generated by individuals in deme $j$.
The migration matrix corresponding to the ODE model above is
$$
\boldsymbol{G}(t,\boldsymbol{Y}, \boldsymbol{Y}^\prime)= 
\left[\begin{array}
{rrrrr}
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
\end{array}\right].
$$
The entry $G_{ij}(t)$ describes the rate at which individuals in deme $i$ migrate from individuals in deme $j$.
The death vector corresponding to the ODE model above is
$$
\boldsymbol{\mu}(t,\boldsymbol{Y}, \boldsymbol{Y}^\prime)= 
\left[\begin{array}
{r}
(\gamma+\mu) I^l_{f0} \\
(\gamma+\mu) I^l_{f1} \\
(\gamma+\mu) I^l_{m0} \\
(\gamma+\mu) I^l_{m1} \\
\end{array}\right].
$$
The non-deme dynamics are given by
$$
\boldsymbol{N}(t,\boldsymbol{Y}, \boldsymbol{Y}^\prime)= 
\left[\begin{array}{r}
\mu*N^l*\frac{S_{f0}}{S^l_{f0}+S^l_{f1}+S^l_{m0}+S^l_{m1}} - \mu*S^l_{f0} - \beta*(\beta_{00}*I^l_{m0}+\beta_{10}*I^l_{m1})*S^l_{f0}/N^l \\
\mu*N^l*\frac{S_{f1}}{S^l_{f0}+S^l_{f1}+S^l_{m0}+S^l_{m1}} - \mu*S^l_{f1} - \beta*(\beta_{01}*I^l_{m0}+\beta_{11}*I^l_{m1})*S^l_{f1}/N^l \\
\mu*N^l*\frac{S_{m0}}{S^l_{f0}+S^l_{f1}+S^l_{m0}+S^l_{m1}} - \mu*S^l_{m0} - \beta*(\beta_{00}*I^l_{f0}+\beta_{10}*I^l_{f1})*S^l_{m0}/N^l \\
\mu*N^l*\frac{S_{m1}}{S^l_{f0}+S^l_{f1}+S^l_{m0}+S^l_{m1}} - \mu*S^l_{m1} - \beta*(\beta_{01}*I^l_{f0}+\beta_{11}*I^l_{f1})*S^l_{m1}/N^l \\
\gamma*I^l_{f0} - \mu*T^l_{f0}\\
\gamma*I^l_{f1} - \mu*T^l_{f1}\\
\gamma*I^l_{m0} - \mu*T^l_{m0}\\
\gamma*I^l_{m1} - \mu*T^l_{m1}\\
\end{array}\right].
$$


The phylodynamic model has 12 states for the local population with initial
values to be specified, and parameters 
$$
(\beta, \beta_{00}, \beta_{01}, \beta_{10}, \beta_{11}, \gamma, \mu),
$$
of which $1$ is over-specified. Our first goal is to explore inference of 
$$
(\beta, \beta_{00}, \beta_{01}, \beta_{10}),
$$
with all other parameters set to the true values in simulations. 

 
## **Simulations**
The following table describes the parameter values and initial values that we
fixed throughout in simulations:
$$
\begin{align}
N^l(0)= & 10^6 & \text{population size Seattle}\\
p_F= & 0.5 & \text{proportion female}\\
s^l= & S^l(0) / N^l(0)= 0.99 & \text{proportion susceptibles}\\
i^l= & I^l(0) / N^l(0)= 0.01*0.2 & \text{proportion infectious}\\
\mu= & 1/40 & \text{birth-death rate}
\end{align} 
$$
The simulations varied in terms of the WAIFM matrix
$$
\boldsymbol{B}= 
\left[\begin{array}
{rrrrr}
\beta_{00} & \beta_{01} \\
\beta_{10} & \beta_{11}\\
\end{array}\right]
$$
in which rows sum to $1$. This means we can interpret $\beta_{ij}$ as the
conditional probability that given an infected class $i$ individual, he
transmits to a susceptible in class $j$ rather than any of the other classes. I
then used endemic equilibrium conditions to determine the model parameters:
$$
\begin{align}
\beta= & 2*\mu*\frac{1-s^l}{i^l s^l}\frac{ \beta_{00}+\beta_{11}-\beta_{01}- \beta_{10} }{ \beta_{00}*(\beta_{11}-\beta_{10})+\beta_{10}*(\beta_{00}-\beta_{01}) }\\
\gamma= & \mu*(1-s^l-i^l)/i^l\\
\end{align} 
$$
and initial conditions:
$$
\begin{align}
p_0= & \frac{\beta_{11}-\beta_{10}}{\beta_{00}+\beta_{11}-\beta_{01}-\beta_{10}} & \text{proportion in class 0}\\
S^l_{f0}= & p_0*p_F*s^l*N^l(0) & \text{number female susceptibles in class 0}\\
S^l_{f1}= & (1-p_0)*p_F*s^l*N^l(0) & \text{number female susceptibles in class 1}\\
S^l_{m0}= & p_0*(1-p_F)*s^l*N^l(0) & \text{number male susceptibles in class 0}\\
S^l_{m1}= & (1-p_0)*(1-p_F)*s^l*N^l(0) & \text{number male susceptibles in class 1}\\
I^l_{f0}= & p_0*p_F*i^l*N^l(0) & \text{number female infectious in class 0}\\
I^l_{f1}= & (1-p_0)*p_F*i^l*N^l(0) & \text{number female infectious in class
1}\\ 
I^l_{m0}= & p_0*(1-p_F)*i^l*N^l(0) & \text{number male infectious in class 0}\\ 
I^l_{m1}= & (1-p_0)*(1-p_F)*i^l*N^l(0) & \text{number male infectious in class 1}\\
T^l_{f0}= & p_0*p_F*(1-s^l-i^l)*N^l(0) & \text{number female treated in class 0}\\
T^l_{f1}= & (1-p_0)*p_F*(1-s^l-i^l)*N^l(0) & \text{number female treated in class 1}\\ 
T^l_{m0}= & p_0*(1-p_F)*(1-s^l-i^l)*N^l(0) & \text{number male treated in class 0}\\ 
T^l_{m1}= & (1-p_0)*(1-p_F)*(1-s^l-i^l)*N^l(0) & \text{number male treated in class 1}\\
\end{align} 
$$

### **Simulation scenarios 1 and 2**
I first wanted to see if no spread between class $0$ and $1$ can be
distinguished from (almost) homogeneous spread between classes $0$ and $1$, with 
$100$, $500$, $1000$ samples from the population obtained in the last $10$
years of an epidemic simulation.

No spread between class $0$ and $1$:
$$
\boldsymbol{\omega}= 
\left[\begin{array}
{rrrrr}
1 & 0 \\
0 & 1\\
\end{array}\right]
$$

The simulated trajectories of the demes and non-demes are at equilibrium as
specified:
```{r, include=TRUE, out.width="90%", out.height="500", fig.show='hold', fig.align='centre', echo=FALSE}
#knitr::include_graphics(c("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim1_trajectories.pdf","/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim1_trajectories.pdf"))
knitr::include_graphics("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim1_trajectories.pdf")
```

... and the transmissions occur within class $0$ and within class $1$:
```{r, include=TRUE, out.width="90%", out.height="500", fig.show='hold', fig.align='centre', echo=FALSE}
knitr::include_graphics("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim1_births.pdf")
```

... and the simulated $\boldsymbol{B}$ matrix has entries as specified:
```{r, include=TRUE, out.width="90%", out.height="500", fig.show='hold', fig.align='centre', echo=FALSE}
knitr::include_graphics("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim1_waifm.pdf")
```

From these simulations, I created $100$ trees of $100$ sampled individuals,
$100$ trees of $500$ sampled individuals, and $100$ trees of $1000$ sampled
individuals. Here is one of them:
```{r, include=TRUE, out.width="90%", out.height="500", fig.show='hold', fig.align='centre', echo=FALSE}
knitr::include_graphics("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim1_tree_sample100_1.pdf")
```



The aim is to compare phylodynamic inference under the scenario of no
spread to that of almost homogeneous between class $0$ and $1$:
$$
\boldsymbol{\omega}= 
\left[\begin{array}
{rrrrr}
0.55 & 0.45 \\
0.45 & 0.55\\
\end{array}\right]
$$
while keeping all else equal. In other words, we have exactly the same epidemic
trajectories at endemic equilibrium for each of the demes and non-demes, but
the flow dynamics are different. Under the above WAIFM matrix, the simulated
trajectories of the demes and non-demes are at equilibrium as specified: 
```{r, include=TRUE, out.width="90%", out.height="500", fig.show='hold', fig.align='centre', echo=FALSE}
#knitr::include_graphics(c("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim1_trajectories.pdf","/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim1_trajectories.pdf"))
knitr::include_graphics("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim2_trajectories.pdf")
```

... and the transmissions occur within and between the classes: 
```{r, include=TRUE, out.width="90%", out.height="500", fig.show='hold', fig.align='centre', echo=FALSE} 
knitr::include_graphics("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim2_births.pdf")
```

... and the simulated $\boldsymbol{B}$ matrix has entries that hover around
50%: 
```{r, include=TRUE, out.width="90%", out.height="500", fig.show='hold', fig.align='centre', echo=FALSE}
knitr::include_graphics("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim2_waifm.pdf")
```

From these simulations, I created again the same number of trees. Here is one of
them: 
```{r, include=TRUE, out.width="90%", out.height="500", fig.show='hold', fig.align='centre', echo=FALSE} 
knitr::include_graphics("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_sim/sim2_tree_sample100_1.pdf")
```

I then re-estimated the parameters
$$
\beta, \beta_{10}, \beta_{01}, \beta_{11}
$$
from the simulated trees under a deterministic demographic process model via
maximum likelihood. I fixed $\beta_{00}=1$ to avoid parameter collinearity and
kept all other parameters at their true values. In the optimisation routine, I
optimised the log of the above parameters to ensure that the estimated
parameters are non-negative on their natural scale.

Here are the results for the inferred $\beta_{ij}/\beta$ (in colours) and their
true counterparts (black crosses):
```{r, include=TRUE, out.width="90%", out.height="500", fig.show='hold', fig.align='centre', echo=FALSE} 
knitr::include_graphics("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_mle/accuracy_sim1_vs_sim2_withCrazy_withNoConv.pdf")
```

I noted that more than half of the ML estimates did not reach convergence, xor
returned very high estimates $>10$. Excluding those gives the following results:
```{r, include=TRUE, out.width="90%", out.height="500", fig.show='hold', fig.align='centre', echo=FALSE} 
knitr::include_graphics("/Users/Oliver/Box Sync/OR_Work/Seattle/phydyn_olli/olli_SITmf01_mle/accuracy_sim1_vs_sim2.pdf")
```

## **Code**

The code to generate the simulations and make phylodynamic inference was:
```{r, include=TRUE, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE,tidy=FALSE} 
<<rmd.chunk.seattle.191017.phydyn.olli.SITmf01.sim>>
```

The code for phylodynamic inference was:
```{r, include=TRUE, eval=TRUE, echo=TRUE, warning=FALSE, message=FALSE,tidy=FALSE} 
<<rmd.chunk.seattle.191017.phydyn.olli.SITmf01.mle>>
```


